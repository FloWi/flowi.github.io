<!doctype html><html lang=en><head><title>Spacetraders Agent written in scala - Architecture overview :: fl(o)wi</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Overview Infrastructure My go-to setup for running infrastructure services locally is docker-compose. I&amp;rsquo;m using postgres as a database and grafana for some dashboards.
docker-compose setup for infrastructure postgres grafana Since I also developed a dashboard for the agents and wanted to reuse some helpers, I added profiles to docker-compose. If I want to start the stack for the agent, I run this command:
docker compose --profile agent up agent architecture I like coding in a functional style and use cats-effect as the runtime effect system."><meta name=keywords content=","><meta name=robots content="noodp"><link rel=canonical href=/posts/architecture-overview/><link rel=stylesheet href=/styles.css><link rel="shortcut icon" href=/img/theme-colors/orange.png><link rel=apple-touch-icon href=/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content="flowi"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Spacetraders Agent written in scala - Architecture overview"><meta property="og:description" content="Overview Infrastructure My go-to setup for running infrastructure services locally is docker-compose. I&amp;rsquo;m using postgres as a database and grafana for some dashboards.
docker-compose setup for infrastructure postgres grafana Since I also developed a dashboard for the agents and wanted to reuse some helpers, I added profiles to docker-compose. If I want to start the stack for the agent, I run this command:
docker compose --profile agent up agent architecture I like coding in a functional style and use cats-effect as the runtime effect system."><meta property="og:url" content="/posts/architecture-overview/"><meta property="og:site_name" content="fl(o)wi"><meta property="og:image" content="/"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2024-03-10 12:15:49 +0100 +0100"></head><body class=orange><div class="container headings--one-size"><link rel=stylesheet href=/css/flowi.css><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/scala.min.js></script><script>hljs.initHighlightingOnLoad()</script><div class=content><article class=post><h1 class=post-title><a href=/posts/architecture-overview/>Spacetraders Agent written in scala - Architecture overview</a></h1><div class=post-meta><time class=post-date>2024-03-10</time><span class=post-author>Florian Witteler</span></div><span class=post-tags>#<a href=/tags/spacetraders/>spacetraders</a>&nbsp;
#<a href=/tags/scala/>scala</a>&nbsp;
#<a href=/tags/scala-js/>scala-js</a>&nbsp;
#<a href=/tags/outwatch/>outwatch</a>&nbsp;</span><div class=post-content><div><h1 id=overview>Overview<a href=#overview class=hanchor arialabel=Anchor>&#8983;</a></h1><h2 id=infrastructure>Infrastructure<a href=#infrastructure class=hanchor arialabel=Anchor>&#8983;</a></h2><p>My go-to setup for running infrastructure services locally is docker-compose. I&rsquo;m using postgres as a database and grafana for some dashboards.</p><ul><li>docker-compose setup for infrastructure<ul><li>postgres</li><li>grafana</li></ul></li></ul><p>Since I also developed a dashboard for the agents and wanted to reuse some helpers, I added profiles to docker-compose. If I want to start the stack for the
agent, I run this command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker compose --profile agent up
</span></span></code></pre></div><h2 id=agent-architecture>agent architecture<a href=#agent-architecture class=hanchor arialabel=Anchor>&#8983;</a></h2><p>I like coding in a functional style and use <a href=https://typelevel.org/cats-effect/>cats-effect</a> as the runtime effect system. I had trouble with the openapi
generator for scala, since it didn&rsquo;t work in some cases or didn&rsquo;t produce code that matches my coding style.</p><p>Luckily the folks at Disney created a nice ecosystem around smithy that worked very well for code generation.
I&rsquo;m using <a href=https://github.com/disneystreaming/smithy-translate>smithy-translate</a> to convert the openapi-spec into a smithy model (with minor fixes) and from
there I use <a href=https://github.com/disneystreaming/smithy4s>smithy4s</a> to generate the client.
Shout out to the authors (especially @Baccata) who were very helpful in their discord channel when I ran into problems.</p><p>The library is awesome and generates code for an <a href=https://http4s.org/>http4s-client</a> that is easily extensible:</p><ul><li>adding authorization via bearer-token</li><li>enabling request logging</li><li>adding rate-limiting with priority <a href=https://github.com/SystemFw/upperbound>upperbound</a></li><li>easy to fix<ul><li>had to change the behavior of posting an empty request; client was sending <code>null</code> but st-server didn&rsquo;t like that</li></ul></li></ul><h3 id=libraries-used>libraries used<a href=#libraries-used class=hanchor arialabel=Anchor>&#8983;</a></h3><table><thead><tr><th>lib</th><th>description</th></tr></thead><tbody><tr><td>smithy-translate</td><td>tool for converting openapi-sepc to smithy model</td></tr><tr><td>smithy4s</td><td>plugin for generating http4s client/server from smithy model</td></tr><tr><td>http4s</td><td>http client/server</td></tr><tr><td>cats-effect</td><td>runtime effect system</td></tr><tr><td>upperbound</td><td>rate limiting for cats-effect IO</td></tr><tr><td>circe</td><td>json (de)serialization</td></tr><tr><td>enumeratum</td><td>better enums for scala</td></tr><tr><td>monocle</td><td>optics library for easier manipulation of nested properties inside immutable datastructures</td></tr><tr><td>flyway</td><td>database migration</td></tr><tr><td>doobie</td><td>functional JDBC layer</td></tr><tr><td>fs2</td><td>functional streaming</td></tr></tbody></table><h2 id=bootstrapping-of-agent>bootstrapping of agent<a href=#bootstrapping-of-agent class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The startup of the agent happens with the unregistered instance of the client. It doesn&rsquo;t use a bearer-token.</p><h3 id=database-migration>database migration<a href=#database-migration class=hanchor arialabel=Anchor>&#8983;</a></h3><p>When I start the agent, the first thing I check is the <a href=https://api.spacetraders.io/v2/>status endpoint</a>. I take the reset-date from its response, parse it and
use it as a schema name in postgres.
e.g. this response</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;SpaceTraders is currently online and available to play&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;v2.1.5&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;resetDate&#34;</span>: <span style=color:#e6db74>&#34;2024-02-25&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>becomes <code>reset_2024_02_25</code>.</p><p>I use flyway to migrate my database schema (it also creates one if it doesn&rsquo;t exist). From there I have a schema ready to be used and instantiate a hikari
connection-pool with the connectionstring.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>def</span> transactorResource<span style=color:#f92672>(</span>connectionString<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>String</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  username<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>String</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  password<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>String</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  schema<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>String</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Resource</span><span style=color:#f92672>[</span><span style=color:#66d9ef>IO</span>, <span style=color:#66d9ef>HikariTransactor</span><span style=color:#f92672>[</span><span style=color:#66d9ef>IO</span><span style=color:#f92672>]]</span> <span style=color:#66d9ef>=</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    ce <span style=color:#66d9ef>&lt;-</span> <span style=color:#a6e22e>ExecutionContexts</span><span style=color:#f92672>.</span>fixedThreadPool<span style=color:#f92672>[</span><span style=color:#66d9ef>IO</span><span style=color:#f92672>](</span><span style=color:#ae81ff>32</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    xa <span style=color:#66d9ef>&lt;-</span> <span style=color:#a6e22e>HikariTransactor</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span>newHikariTransactor<span style=color:#f92672>[</span><span style=color:#66d9ef>IO</span><span style=color:#f92672>](</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;org.postgresql.Driver&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        connectionString<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        username<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        password<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        ce<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span>evalTap<span style=color:#f92672>(</span>tx <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>        tx<span style=color:#f92672>.</span>configure <span style=color:#f92672>{</span> ds <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Async</span><span style=color:#f92672>[</span><span style=color:#66d9ef>IO</span><span style=color:#f92672>].</span>delay <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            ds setSchema schema
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>yield</span> xa
</span></span></code></pre></div><p>After that step I modify the readonly grafana user to have that schema as default in its search path.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Grant usage and all privileges on the schema to the user
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>GRANT</span> <span style=color:#66d9ef>USAGE</span> <span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>SCHEMA</span> reset_2024_02_25 <span style=color:#66d9ef>TO</span> grafana_user;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>GRANT</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>ALL</span> TABLES <span style=color:#66d9ef>IN</span> <span style=color:#66d9ef>SCHEMA</span> reset_2024_02_25 <span style=color:#66d9ef>TO</span> grafana_user;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- Grant all privileges on new tables in the schema to the user
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>PRIVILEGES</span> <span style=color:#66d9ef>IN</span> <span style=color:#66d9ef>SCHEMA</span> reset_2024_02_25
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>GRANT</span> <span style=color:#66d9ef>ALL</span> <span style=color:#66d9ef>ON</span> TABLES <span style=color:#66d9ef>TO</span> grafana_user;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- Set the default search path to the new schema
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>USER</span> grafana_user <span style=color:#66d9ef>SET</span> search_path <span style=color:#66d9ef>TO</span> reset_2024_02_25;
</span></span></code></pre></div><p>That way I don&rsquo;t need to update the grafana dashboard with new connectionstrings.</p><h3 id=registering-my-agent-if-necessray>registering my agent if necessray<a href=#registering-my-agent-if-necessray class=hanchor arialabel=Anchor>&#8983;</a></h3><p>On startup I check my <code>registration</code> table to see if I already registered my agent and use its token. If not I use the infos from env vars to register. I added
a 10s delay before registering, because I forgot to change some settings in the past ;-)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#a6e22e>IO</span><span style=color:#f92672>.</span>println<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>s&#34;&#34;&#34;Registering agent with these details:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     |  Symbol: </span><span style=color:#e6db74>${</span>registrationInputBody<span style=color:#f92672>.</span>symbol<span style=color:#e6db74>}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     |  E-Mail: </span><span style=color:#e6db74>${</span>registrationInputBody<span style=color:#f92672>.</span>email<span style=color:#e6db74>}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     |  Faction: </span><span style=color:#e6db74>${</span>registrationInputBody<span style=color:#f92672>.</span>faction<span style=color:#e6db74>}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     |
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     |You have 10s to cancel if you want to change anything.&#34;&#34;&#34;</span><span style=color:#f92672>.</span>stripMargin<span style=color:#f92672>)</span> <span style=color:#f92672>*&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>IO</span><span style=color:#f92672>.</span>sleep<span style=color:#f92672>(</span><span style=color:#ae81ff>10.</span>seconds<span style=color:#f92672>)</span> <span style=color:#75715e>/* *&gt; ... */</span>
</span></span></code></pre></div><h2 id=background-collection-of-big-data>background collection of &ldquo;big&rdquo; data<a href=#background-collection-of-big-data class=hanchor arialabel=Anchor>&#8983;</a></h2><p>In my codebase I use two different clients that talk to the st-servers. One with a high priority that controls the ships or loads essential data and another one
with a low priority that collects data in the background (like systems, waypoints, jump-gates etc.)</p><p>The low priority client is used in a streaming context (with fs2) to prevent excessive memory usage and provide back-pressure. It&rsquo;s also straightforward to ingest responses from the paginated endpoints.</p><p>Here&rsquo;s an example in where I collect the waypoints of a system:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>def</span> loadSystemWaypointsPaginated<span style=color:#f92672>(</span>systemSymbol<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>String</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Stream</span><span style=color:#f92672>[</span><span style=color:#66d9ef>IO</span>, <span style=color:#66d9ef>GetSystemWaypoints200</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Stream</span><span style=color:#f92672>.</span>eval<span style=color:#f92672>(</span>getListWaypointsPageIO<span style=color:#f92672>(</span>systemSymbol<span style=color:#f92672>,</span> <span style=color:#a6e22e>PaginationInput</span><span style=color:#f92672>(</span>page <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>Some</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>),</span> limit <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>Some</span><span style=color:#f92672>(</span><span style=color:#ae81ff>20</span><span style=color:#f92672>))))</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>flatMap <span style=color:#f92672>{</span> first <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>val</span> rest <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>PaginationHelper</span><span style=color:#f92672>.</span>calcRestRequests<span style=color:#f92672>(</span>first<span style=color:#f92672>.</span>body<span style=color:#f92672>.</span>meta<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>val</span> restStream<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Stream</span><span style=color:#f92672>[</span><span style=color:#66d9ef>IO</span>, <span style=color:#66d9ef>GetSystemWaypoints200</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>Stream</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span>iterable<span style=color:#f92672>(</span>rest<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span>lift<span style=color:#f92672>[</span><span style=color:#66d9ef>IO</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span>evalMap<span style=color:#f92672>(</span>page <span style=color:#66d9ef>=&gt;</span> getListWaypointsPageIO<span style=color:#f92672>(</span>systemSymbol<span style=color:#f92672>,</span> page<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Stream</span><span style=color:#f92672>(</span>first<span style=color:#f92672>)</span> <span style=color:#f92672>++</span> restStream
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>collect first page</li><li>take <code>Meta</code> object from response of the first page to</li><li>calculate the numbers of the remaining pages to create a stream</li><li>concat the first page with the rest of the stream</li></ul><h2 id=heading><a href=#heading class=hanchor arialabel=Anchor>&#8983;</a></h2></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=/posts/adventofcode/2021/solver/><span class=button__text>Adventofcode - Solver in scala.js</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>